<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2U代購訂單自助查詢</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .order-card { transition: all 0.3s ease; }
        .animate-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTI2u0l6e4K6kogVUgDcKmAZA7Eec4k2DLjvlHIhhKZUDwuciNsgjs6KY8jjWc7IjfxLqXQNCKh5adv/pub?output=csv";

        const Icon = ({ size = 20, className = "", children }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const ShoppingBag = (props) => <Icon {...props}><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></Icon>;
        const User = (props) => <Icon {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></Icon>;
        const Calendar = (props) => <Icon {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></Icon>;
        const Tag = (props) => <Icon {...props}><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"/><path d="M7 7h.01"/></Icon>;
        const CheckCircle = (props) => <Icon {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></Icon>;
        const AlertCircle = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></Icon>;
        const ClipboardList = (props) => <Icon {...props}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></Icon>;

        const ReconcileBadge = ({ status }) => {
            const s = status?.trim();
            if (s === "已收到款項") return <span className="text-green-600 font-bold bg-green-50 px-3 py-1.5 rounded-lg text-base border border-green-100">對帳完成</span>;
            if (s === "對帳中") return <span className="text-orange-500 font-bold bg-orange-50 px-3 py-1.5 rounded-lg text-base border border-orange-100">對帳中</span>;
            if (s?.includes("有誤")) return <span className="text-red-600 font-bold bg-red-50 px-3 py-1.5 rounded-lg text-base border border-red-100">{s}</span>;
            return <span className="text-slate-400 font-bold text-base bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-100">{s || "未對帳"}</span>;
        };

        const ProgressBadge = ({ status }) => {
            if (!status) return null;
            return (
                <span className="flex items-center text-indigo-700 bg-indigo-50 px-3 py-1.5 rounded-xl text-sm font-bold border border-indigo-100 shadow-sm">
                    <ClipboardList size={14} className="mr-1.5" /> {status}
                </span>
            );
        };

        const PaymentBadge = ({ status }) => {
            const s = status?.trim();
            if (s === "已回報付款") return <span className="text-blue-700 bg-blue-50 px-3 py-2 rounded-xl text-sm font-bold border border-blue-100 shadow-sm"><CheckCircle size={14} className="inline mr-1.5" />已回報付款</span>;
            if (s === "未付款") return <span className="text-red-600 bg-red-50 px-3 py-2 rounded-xl text-sm font-bold border border-red-100 shadow-sm"><AlertCircle size={14} className="inline mr-1.5" />未付款</span>;
            return <span className="text-slate-500 bg-slate-50 px-3 py-2 rounded-xl text-sm font-bold border border-slate-100">{s || "狀態確認中"}</span>;
        };

        const App = () => {
            const [data, setData] = useState([]);
            const [queryName, setQueryName] = useState("");
            const [queryPhone, setQueryPhone] = useState("");
            const [searchResult, setSearchResult] = useState(null);
            const [loading, setLoading] = useState(true);
            const [hasSearched, setHasSearched] = useState(false);
            const [error, setError] = useState("");

            useEffect(() => { fetchData(); }, []);

            const fetchData = () => {
                setLoading(true);
                Papa.parse(SHEET_CSV_URL, {
                    download: true, 
                    header: true, 
                    skipEmptyLines: true,
                    transformHeader: (h) => h.trim(),
                    complete: (results) => { 
                        setData(results.data);
                        setLoading(false); 
                    },
                    error: (err) => { 
                        setError("無法連線至雲端試算表");
                        setLoading(false); 
                    }
                });
            };

            const handleSearch = (e) => {
                e.preventDefault();
                setHasSearched(true);
                const rows = data.filter(row => 
                    row["姓名"]?.toString().trim() === queryName.trim() && 
                    row["手機末三碼"]?.toString().trim() === queryPhone.trim()
                );

                if (rows.length === 0) { setSearchResult(null); return; }

                const groupsMap = {};
                rows.forEach(row => {
                    const gName = row["團名"] || "其他";
                    if (!groupsMap[gName]) {
                        groupsMap[gName] = {
                            groupName: gName,
                            type: row["類型"] || "代購",
                            eta: row["預計到貨時間"] || "未定",
                            progress: row["團務進度"],
                            paymentStatus: row["匯款進度"],
                            reconcileStatus: row["對帳狀況"],
                            sellerNote: row["賣家留言"],
                            remark: row["備註"],
                            items: [],
                            grandTotal: 0
                        };
                    }

                    const qty = parseInt(row["數量"] || 0);
                    const price = parseFloat(row["單價"] || 0);
                    const subtotal = parseFloat(row["合計"] || (qty * price));

                    groupsMap[gName].items.push({
                        name: row["品項"] || "-",
                        qty: qty,
                        price: price,
                        total: subtotal
                    });
                    
                    groupsMap[gName].grandTotal += subtotal;
                });

                setSearchResult(Object.values(groupsMap));
            };

            return (
                <div className="max-w-2xl mx-auto py-12 px-4">
                    <div className="text-center mb-10">
                        <div className="bg-indigo-600 w-20 h-20 rounded-[2rem] flex items-center justify-center mx-auto mb-6 shadow-2xl shadow-indigo-200">
                            <ShoppingBag className="text-white" size={36} />
                        </div>
                        <h1 className="text-3xl font-black text-slate-900 tracking-tight">2U代購訂單自助查詢</h1>
                    </div>

                    {/* 搜尋區 */}
                    <div className="bg-white p-8 rounded-[2.5rem] shadow-xl shadow-slate-200/50 border border-slate-100 mb-10">
                        {loading ? (
                            <div className="text-center py-6 flex flex-col items-center">
                                <div className="w-10 h-10 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-4"></div>
                                <span className="font-bold text-slate-500 text-lg">雲端資料同步中...</span>
                            </div>
                        ) : error ? (
                            <div className="text-red-500 font-bold text-center py-4 bg-red-50 rounded-2xl text-lg">{error}</div>
                        ) : (
                            <form onSubmit={handleSearch} className="space-y-6">
                                <div className="grid grid-cols-2 gap-6">
                                    <div>
                                        <label className="block text-xs font-black text-slate-400 mb-2 ml-1 uppercase tracking-widest">姓名</label>
                                        <input type="text" required className="w-full bg-slate-50 border-2 border-transparent rounded-2xl px-6 py-4 focus:bg-white focus:border-indigo-500 transition-all font-bold text-slate-700 outline-none text-lg" placeholder="社群名稱" value={queryName} onChange={(e) => setQueryName(e.target.value)} />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-black text-slate-400 mb-2 ml-1 uppercase tracking-widest">手機末三碼</label>
                                        <input type="text" required maxLength="3" className="w-full bg-slate-50 border-2 border-transparent rounded-2xl px-6 py-4 focus:bg-white focus:border-indigo-500 transition-all font-bold text-slate-700 outline-none text-lg" placeholder="例:123" value={queryPhone} onChange={(e) => setQueryPhone(e.target.value)} />
                                    </div>
                                </div>
                                <div className="px-10">
                                    <button className="w-full bg-slate-900 text-white font-bold py-3.5 rounded-2xl hover:bg-indigo-600 active:scale-[0.98] transition-all shadow-lg text-lg tracking-widest">
                                        查詢我的訂單
                                    </button>
                                </div>
                            </form>
                        )}
                    </div>

                    {/* 查無資料 */}
                    {hasSearched && !searchResult && (
                        <div className="text-center py-20 bg-white rounded-[3rem] border-2 border-dashed border-slate-100 animate-in">
                            <AlertCircle className="mx-auto text-slate-200 mb-4" size={56} />
                            <p className="text-slate-400 font-black text-2xl tracking-tight">查無符合條件的訂單</p>
                            <p className="text-slate-300 text-base mt-2">請重新確認輸入資料，或向主揪反映。</p>
                        </div>
                    )}

                    {/* 結果列表 */}
                    {searchResult && (
                        <div className="space-y-10">
                            {/* 已刪除原有的姓名標題區塊，直接顯示訂單卡片 */}
                            {searchResult.map((group, index) => (
                                <div key={index} className="order-card bg-white rounded-[3rem] shadow-2xl shadow-slate-200/40 border border-slate-100 overflow-hidden animate-in" style={{animationDelay: `${index * 0.1}s`}}>
                                    {/* 頂部標題列 */}
                                    <div className="bg-slate-50/80 px-8 py-6 border-b border-slate-100 flex justify-between items-center flex-wrap gap-4">
                                        <div className="flex items-center space-x-3">
                                            <span className={`text-xs font-black px-4 py-2 rounded-xl uppercase tracking-wider shadow-sm ${group.type?.includes('預購') ? 'bg-indigo-600 text-white' : 'bg-rose-500 text-white'}`}>
                                                {group.type}
                                            </span>
                                            <h3 className="font-bold text-slate-800 text-base tracking-tight">{group.groupName}</h3>
                                        </div>
                                        <PaymentBadge status={group.paymentStatus} />
                                    </div>
                                    
                                    <div className="p-8">
                                        {/* 進度資訊區 */}
                                        <div className="flex flex-wrap gap-3 mb-8">
                                            <div className="flex items-center text-sm text-slate-600 bg-slate-50 px-5 py-2.5 rounded-2xl font-black border border-slate-100 shadow-sm">
                                                <Calendar size={16} className="mr-2.5 text-indigo-500" />
                                                預計到貨：<span className="text-slate-900 ml-1 font-black underline decoration-indigo-200 underline-offset-4">{group.eta}</span>
                                            </div>
                                            {group.progress && <ProgressBadge status={group.progress} />}
                                        </div>

                                        {/* 品項詳細表格 */}
                                        <div className="mb-10 overflow-x-auto">
                                            <table className="w-full text-base">
                                                <thead>
                                                    <tr className="text-slate-400 border-b border-slate-100">
                                                        <th className="text-left py-4 font-black uppercase text-[10px] tracking-[0.1em]">品項內容</th>
                                                        <th className="text-center py-4 font-black uppercase text-[10px] tracking-[0.1em] px-4">數量</th>
                                                        <th className="text-right py-4 font-black uppercase text-[10px] tracking-[0.1em] px-4">單價</th>
                                                        <th className="text-right py-4 font-black uppercase text-[10px] tracking-[0.1em] pl-4">合計</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    {group.items.map((item, i) => (
                                                        <tr key={i} className="group transition-colors">
                                                            <td className="py-4 text-slate-700 font-bold leading-relaxed max-w-[200px] text-[13px]">{item.name}</td>
                                                            <td className="py-4 text-center font-mono text-slate-500 font-bold text-sm">×{item.qty}</td>
                                                            <td className="py-4 text-right font-mono text-slate-500 font-bold text-sm">${item.price}</td>
                                                            <td className="py-4 text-right font-mono text-slate-900 font-black tracking-tighter text-base">${item.total}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>

                                        {/* 底部總計與對帳 */}
                                        <div className="flex justify-between items-end pt-8 border-t-2 border-slate-100">
                                            <div>
                                                <span className="text-sm text-slate-400 font-black uppercase tracking-[0.1em] block mb-1.5 ml-1">合計</span>
                                                <div className="text-xl font-black text-slate-900 tracking-tighter flex items-center">
                                                    <span className="text-sm mt-1 mr-1 text-slate-300 font-bold">$</span>
                                                    {group.grandTotal}
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <span className="text-xs text-slate-400 font-black uppercase tracking-[0.1em] block mb-2 mr-1">對帳狀態</span>
                                                <ReconcileBadge status={group.reconcileStatus} />
                                            </div>
                                        </div>

                                        {/* 留言與備註 */}
                                        {(group.sellerNote || group.remark) && (
                                            <div className="mt-10 space-y-4">
                                                {group.sellerNote && (
                                                    <div className="bg-amber-50/60 p-6 rounded-[2rem] flex items-start space-x-4 border border-amber-100/50 shadow-sm">
                                                        <div className="bg-amber-100 p-2.5 rounded-xl h-fit shadow-sm"><Tag className="text-amber-600" size={18} /></div>
                                                        <div className="text-base text-amber-950 font-bold whitespace-pre-line leading-relaxed">
                                                            <span className="block text-xs uppercase tracking-widest text-amber-500 mb-1.5 font-black">賣家留言 Message</span>
                                                            {group.sellerNote}
                                                        </div>
                                                    </div>
                                                )}
                                                {group.remark && (
                                                    <div className="bg-slate-50 p-6 rounded-[2rem] flex items-start space-x-4 border border-slate-100 shadow-sm">
                                                        <div className="bg-slate-200 p-2.5 rounded-xl h-fit shadow-sm"><ClipboardList className="text-slate-500" size={18} /></div>
                                                        <div className="text-base text-slate-700 font-bold whitespace-pre-line leading-relaxed">
                                                            <span className="block text-xs uppercase tracking-widest text-slate-400 mb-1.5 font-black">您的備註 Remark</span>
                                                            {group.remark}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>